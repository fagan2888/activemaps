<html>
<head>
<meta charset="utf-8">
<title>CHTS Map</title>
<style>
html { height: 100%; }
body { background-color: grey; height: 100%; margin: 0; padding: 0;}
.overlay {
  fill: none;
  pointer-events: all;
}
.boundary {
  fill: none;
  stroke: #FFF;
  stroke-width: .5px;
}
</style>
<body>
<div id=metainfo style="user-select: none; position: absolute; left: 350px; background-color: grey; color: white; font-size: 32px; font-family: Arial;">
Hour 00, Income 05
</div>

<script src="js/d3.v3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script type="text/javascript">
  
var width  = 1440,
    height = 900;

var modecolor = function(d) {
  if (d == 3) return "red";      // walk
  if (d == 2) return "orange";  // bike
  if (d == 1) return "yellow"; // transit
  if (d == 4) return "green"; // other
  if (d == 5) return "blue"; // car
} 

var projection = d3.geo.mercator()
  .center([-122.4191, 37.7792 ])
  .scale(100000);

var scale = 1.0;

var zoom = d3.behavior.zoom()
  .scaleExtent([1,8])
  .on("zoom", move);

function move() {
  var t = d3.event.translate,
  s = d3.event.scale;
  scale = s;
  t[0] = Math.min(width / 2 * (s - 1), Math.max(width / 2 * (1 - s), t[0]));
  t[1] = Math.min(height / 2 * (s - 1) + 230 * s, Math.max(height / 2 * (1 - s) - 230 * s, t[1]));
  zoom.translate(t);
  g.style("stroke-width", 1 / s).attr("transform", "translate(" + t + ")scale(" + s + ")");
  redraw(d3.mouse(this));
}

svg = d3.select("body").append("svg")
  .attr("width", width)
  .attr("height", height)
  .on("mousemove", function() { redraw(d3.mouse(this)); })
  .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
  .append("g")
  .call(zoom);

var g = svg.append("g");

svg.append("rect")
  .attr("class", "overlay")
  .attr("x", -width / 2)
  .attr("y", -height / 2)
  .attr("width", width)
  .attr("height", height);

d3.json("counties.json", function(error, d) {
  g.append("path")
    .datum(topojson.mesh(d, d.objects.counties))
    .attr("d", d3.geo.path().projection(projection))
    .attr("class", "boundary");    
});

var data = {};

d3.csv("minibats.csv", function(d) {
    return {
      hhid:  +d.SAMPN,
      perno: +d.PERNO,
      inc:   +Math.ceil(d.INCOM/2),
      plano: +d.PLANO,
      purp:  +d.APURP1,
      mode:  +d.MODE,
      age:   +d.AGE,
      hour:  +d.ARR_HR,
      lon:   projection([+d.XCORD, +d.YCORD])[0],
      lat:   projection([+d.XCORD, +d.YCORD])[1],
    };
  }, function(error, rows) {

  rows.forEach(function(r) {
    var key = [r.hhid,r.perno];
    if(!(key in data)) data[key] = {'key': key, 'first': r};
    data[key][r.hour] = r;
  });
  data = Object.keys(data).map(function(key){return data[key];});

  var income = 5;
  g.selectAll("circle")
    .data(data,keyf)
    .enter()
    .append("circle")
    .attr("cx", function(d) { return d['first'].lon })
    .attr("cy", function(d) { return d['first'].lat })
    .attr("r", function(d) { return d['first'].age/15/scale; })
    .style("fill", function(d) { return modecolor(d['first'].mode); })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
});

function keyf(d) { return d['key']; }

function redraw(mouse) {
  var hour = Math.floor(mouse[0]/width*24) + 1;
  var income = 5 - Math.floor(mouse[1]/height*5);
  d3.select("#metainfo").text("Hour "+(hour<10?"0":"")+hour+", Income "+(income<10?"0":"")+income);
  g.selectAll("circle")
    .data(data.filter(function(d){return hour in d}),keyf)
    .style("fill", function(d) { return modecolor(d[hour].mode); })
    .transition().duration(2000)
    .attr("cx", function(d) { return d[hour].lon })
    .attr("cy", function(d) { return d[hour].lat });
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/15/scale; })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
}
</script>
