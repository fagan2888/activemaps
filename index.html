<html>
<head>
<meta charset="utf-8">
<title>BATSMAPS</title>
<style>
html { height: 100%; }
body {height: 100%; margin: 0; padding: 0;}
#map{ height: 100% }
</style>
<link rel="stylesheet" href="js/leaflet.css" />
<script src="js/leaflet.js"></script>
<script type="text/javascript" src="js/tile.stamen.js"></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<body>
<div id="map" style="width:100%; height:100%; position:fixed; left:0; top:0; overflow:hidden;"></div>
<div id=metainfo unselectable="on" class="unselectable" style="border-width: thick; border-color: black; border-style: solid; position: absolute; left: 10px; bottom: 10px; background-color: black; color: white; font-size: 24px; font-family: Arial;">
Hour 00, Income 05
</div>
<script type="text/javascript">

var map = new L.Map("map", {center: [37.7792, -122.4191], zoom: 12});
var layer = new L.StamenTileLayer("watercolor");
map.addLayer(layer);
//L.tileLayer("http://{s}.tiles.mapbox.com/v3/examples.map-b70jh5xu/{z}/{x}/{y}.png",
//    {subdomains: 'a',type:'map',minZoom:10,maxZoom:18}).addTo(map);

var modecolor = function(d) {
  if (d == 3) return "red";      // walk
  if (d == 2) return "orange";  // bike
  if (d == 1) return "yellow"; // transit
  if (d == 4) return "green"; // other
  if (d == 5) return "blue"; // car
} 

function project(x) {
  var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
  return [point.x, point.y];
}

var scale = 1.0;

var svg = d3.select(map.getPanes().overlayPane).append("svg")
  .on("mousemove", function() { redraw(d3.mouse(this)); });

var g = svg.append("g").attr("class", "leaflet-zoom-hide");

var data = {};
var bounds;

d3.csv("minibats.csv", function(d) {
    return {
      hhid:  +d.SAMPN,
      perno: +d.PERNO,
      inc:   +Math.ceil(d.INCOM/2),
      plano: +d.PLANO,
      purp:  +d.APURP1,
      mode:  +d.MODE,
      age:   +d.AGE,
      hour:  +d.ARR_HR,
      lon:   +d.XCORD,
      lat:   +d.YCORD,
      plon:  project([+d.XCORD,+d.YCORD])[0],
      plat:  project([+d.XCORD,+d.YCORD])[1],
    };
  }, function(error, rows) {

  rows.forEach(function(r) {
    var key = [r.hhid,r.perno];
    if(!(key in data)) data[key] = {'key': key, 'first': r};
    data[key][r.hour] = r;
  });
  data = Object.keys(data).map(function(key){return data[key];});

  var ne = map.getBounds()._northEast;
  var sw = map.getBounds()._southWest;
  bounds = [[sw.lng,sw.lat],[ne.lng,ne.lat]];
  map.on("viewreset", rezoom);
  rezoom();

  var income = 5;
  g.selectAll("circle")
    .data(data,keyf)
    .enter()
    .append("circle")
    .attr("cx", function(d) { return d['first'].plon; })
    .attr("cy", function(d) { return d['first'].plat; })
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); })
    .style("fill", function(d) { return modecolor(d['first'].mode); })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
  
});

function keyf(d) { return d['key']; }

function rezoom() {
  var bottomLeft = project(bounds[0]),
      topRight = project(bounds[1]);

  svg.attr("width", topRight[0] - bottomLeft[0])
     .attr("height", bottomLeft[1] - topRight[1])
     .style("margin-left", bottomLeft[0] + "px")
     .style("margin-top", topRight[1] + "px");

  g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");
  scale = Math.pow(2,map.getZoom() - 12)
  g.attr("transform", "scale("+scale+")");
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); });
}

function redraw(mouse) {
  var bottomLeft = project(bounds[0]),
      topRight = project(bounds[1]);
  var hour = Math.floor((mouse[0]+bottomLeft[0])/map.getSize().x*24) + 1;
  var income = Math.floor((mouse[1]+topRight[1])/map.getSize().y*5) + 1;
  income = 6 - income;
  d3.select("#metainfo").text("Hour "+(hour<10?"0":"")+hour+", Income "+(income<10?"0":"")+income);
  g.selectAll("circle")
    .data(data.filter(function(d){return hour in d}),keyf)
    .style("fill", function(d) { return modecolor(d[hour].mode); })
    .transition().duration(2000)
    .attr("cx", function(d) { return d[hour].plon; }) //project([d[hour].lon,d[hour].lat])[0]; })
    .attr("cy", function(d) { return d[hour].plat; }) //project([d[hour].lon,d[hour].lat])[1]; });
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
}
</script>
</body>
</html>
