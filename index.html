<html>
<head>
<meta charset="utf-8">
<link rel="icon" href="bat.ico" type="image/x-icon">
<title>ActiveMaps</title>
<style>
.legend {
  line-height: 18px;
  color: #555;
}
.legend i {
  width: 15px;
  height: 15px;
  float: left;
  margin-right: 8px;
  opacity: 0.8;
}
.info {
  padding: 6px 8px;
  font: 14px/16px Arial, Helvetica, sans-serif;
  background: white;
  background: rgba(255,255,255,0.9);
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 5px;
}
.info h4 {
  margin: 0 0 5px;
  color: #777;
}
html { height: 100%; }
body {height: 100%; margin: 0; padding: 0;}
#map{ height: 100% }
</style>
<link rel="stylesheet" href="js/leaflet.css" />
<script src="js/leaflet.js"></script>
<script type="text/javascript" src="js/tile.stamen.js"></script>
<link rel="stylesheet" href="js/nv.d3.css" />
<script src="js/d3.v3.js"></script>
<script src="js/nv.d3.js"></script>
<script src="js/topojson.v1.min.js"></script>
<link rel="stylesheet" href="js/colorbox.css" />
<link rel="stylesheet" href="js/jquery-ui.css" />
<script src="js/jquery-1.9.1.js"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/jquery.colorbox.js"></script>
</head>
<body>
<div id="map" style="width:100%; height:100%; position:fixed; left:0; top:0; overflow:hidden;"></div>
<div id=metainfo unselectable="on" class="unselectable" style="border-width: thin; border-color: #262626; border-style: solid; position: absolute; left: 45px; top: 10px; background-color: #262626; color: white; font-size: 24px; font-family: Arial; text-shadow: 2px 2px #888; border-radius: 4px;">01:00</div>
<div id="slider" style="position: absolute; top: 17px; left: 120px; width:240px;"></div>
<!--<div id="legend" class="info legend" style="position: absolute; top: 10px; right: 10px;"></div>-->
<div id="regionchooser" style="position:absolute; left: 45px; top: 45px; border-width: thin; border-color: #262626; border-style: solid; background-color: #262626; font-family: Arial; font-size: 14px; border-radius: 4px; color: white;">
Region:<br>
<select style="width: 100px;">
    <option value=newyork>New York</option>
    <option value=bayarea>Bay Area</option>
    <option value=losangeles>Los Angeles</option>
    <option value=sandiego>San Diego</option>
    <option value=sacramento>Sacramento</option>
    <option value=bakersfield>Bakersfield</option>
    <option value=fresno>Fresno</option>
    <option value=monterey>Monterey</option>
</select>
</div>
<div id="modechart" style="position:absolute; top: 8px; right: 8px; height: 250px; width:250px; background-color: rgba(255,255,255,.7)"><svg></svg></div>
<div id="incomechooser" style="position:absolute; left: 155px; top: 45px; border-width: thin; border-color: #262626; border-style: solid; background-color: #262626; font-family: Arial; font-size: 14px; border-radius: 4px; color: white;">
Household Income:<br>
<select style="width: 110px;">
    <option value=1>up to 15k</option>
    <option value=2>15k to 30k</option>
    <option value=3>30k to 50k</option>
    <option value=4>50k to 75k</option>
    <option value=5>75k to 100k</option>
    <option value=6 selected>100k to 150k</option>
    <option value=7>150k to 200k</option>
    <option value=8>200k and up</option>
</select>
</div>
<div>
<p><a style="position:absolute; left: 0px; bottom: 0px; border-radius: 4px;" href="http://www.synthicity.com"><img height=23px  src="images/logo.png"/></a></p>
</div>
<div>
<p><a style="position:absolute; left: 362px; top: 8px;" href="javascript:play();"><img height=33px  src="images/button_black_play.png"/></a></p>
</div>
<div>
<p><a style="position:absolute; left: 392px; top: 8px;" href="javascript:stop();"><img height=33px  src="images/button_black_stop.png"/></a></p>
</div>
<div>
<p><a class='inline' style="position:absolute; left: 11px; top: 70px;" href="#inline_content"><img height=23px  src="qmark.ico"/></a></p>
</div>
        <div style='display:none'>
            <div id='inline_content' style='padding:10px; background:#fff;'>
            <p><strong>This page visualizes the public version of the travel diaries for households that participated in the 2010 NYMTC Travel Survey as well as the 2010 California Household Travel Survey.</strong></p>
            <p><i>Because this is the public data, positions are actually randomized within census tracts; exact lat-long locations are not accurate in order to protect the privacy of the individual survey takers.  The modifications should not affect the general patterns of travel by income, mode, or time of day.</i></p>
            <p>You can advance the time of day by dragging the time slider from left to right and change the range of household incomes that are displayed using the drop down box.</p>
            <p>Each circle represents a person and is sized relative to the age of the person.  Look closely and you can see a parent (large circle) traveling with a child (small circle).
            <p>Circles are colored by the last transportation mode taken by each person (see legend).  The "home" mode is used for people who haven't left home and do not have a mode yet.  Notice that mode colors will be inaccurate when moving the slider *backwards* in time.</p>
            <p><i>The speed of each trip is not accounted for when moving the circles - each animation takes the same amount of time no matter the duration of the trip.</i></p>
            <p>Many thanks to <a href="http://www.synthicity.com">Synthicity</a> for supporting my work on this project and for the <a href=http://vudlab.com/#/">vudlab</a> for inspiring me to try this.  Additional thanks to Nicholas Tapia for helping with the New York data.<br><br>Email me - Fletcher Foti - at ffoti @ berkeley.edu or help me make this project better on <a href="https://github.com/fscottfoti/activemaps">github</a>.
            <p><a href="#" onclick="$.colorbox.close();" color=black>Close</a></p>
            </div>
        </div>
</pre>
<script type="text/javascript">
var loopcnt = 0;
function play() {
  if(loopcnt > 0) return;
  loopcnt = 19;
  $("#slider").slider('value',25-loopcnt);
  redraw(25-loopcnt);
  loopcnt--;
  (function myLoop () {          
    setTimeout(function () {
      if (loopcnt <= 0) return;      
      $("#slider").slider('value',25-loopcnt);
      redraw(25-loopcnt);
      --loopcnt;
      myLoop();
   }, 2000)
  })();
}
function stop() {
  loopcnt = 0;
}

$(function() {
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44927674-1', 'synthicity.com');
  ga('send', 'pageview');
  $(".inline").colorbox({inline:true, width:"50%", opacity: .6});

  var labels = [];
  for (var i = 0; i < modes.length; i++) {
    labels.push('<i style="background:' + modecolor(i+1) + '"></i>' +modes[i]);
  }
  var legend = labels.join('<br>')+"<br>Size=Age";
  $("#legend").html(legend);

  $( "#slider" ).slider({
    min: 1,
    max: 24,
    step: 1,
    slide: function( event, ui ) { redraw(ui.value); }
  });

  $("#regionchooser").change(function(s) {
    region = $("#regionchooser").find(":selected").val();
    map.panTo(centerd[region]);
    map.setZoom(basezoom);
    setbounds(region);
    readcsv(region,income);
  });
  $("#incomechooser").change(function(s) {
    income = $("#incomechooser").find(":selected").val();
    readcsv(region,income);
  });
});

if(document.URL.indexOf('?') == -1) var region = "newyork";
else var region = document.URL.substring(document.URL.indexOf('?')+1);
if($.inArray(region,["sandiego","newyork","bayarea","monterey","sacramento","bakersfield","losangeles","fresno"])==-1)
  alert("Region must be one of newyork, sandiego, bayarea, monterey, sacramento, bakersfield, losangeles, fresno");
var centerd = {"sandiego": [32.73,-117.07], "monterey": [36.78,-121.85], "sacramento": [38.57,-121.5], "bakersfield": [35.33,-119.05], "fresno": [36.77,-119.72],"bayarea": [37.7792,-122.3391],"losangeles":[34.05,-118.24],"newyork":[40.78,-73.97]}
var center = centerd[region]
var basezoom = 12;
if(region == "monterey") basezoom = 10;

var map = new L.Map("map", {center: center, zoom: basezoom});
var layer = new L.StamenTileLayer("toner-lite");
map.addLayer(layer);

var modes = ["Transit","Bike","Walk","Other","Car","Home"];
var modecolor = function(d) {
  if (d == 3) return "red";      // walk
  if (d == 2) return "orange";  // bike
  if (d == 1) return "yellow"; // transit
  if (d == 4) return "green"; // other
  if (d == 5) return "blue"; // car
  if (d == 6) return "brown"; // home
} 

function project(x) {
  var point = map.project(new L.LatLng(x[1], x[0]),basezoom);
  return [point.x, point.y];
}

var scale = 1.0;
var svg = d3.select(map.getPanes().overlayPane).append("svg")
var g = svg.append("g").attr("class", "leaflet-zoom-hide");

var data = {};
var income = 6;
  
var bounds, projbounds;
var defbounds = [[-124.475,42.223],[-114.604,32.04]];
var boundsd = {"newyork": [[-75.2,42.05],[-72.0,39.57]]}
function setbounds(region) {
  if(region in boundsd) bounds = boundsd[region];
  else bounds = defbounds;
  projbounds = [project(bounds[0]),project(bounds[1])] 
}
setbounds(region);


map.on("viewreset", rezoom);
map.on("moveend", rechart);   

function mostrecent(d,hour) {
  for(;hour>0;hour--) {
    if(hour in d) return d[hour];
  }
  return d['first'];
}

var chart = nv.models.pieChart()
  .x(function(d) { return d.label })
  .y(function(d) { return d.value })
  .color(function(d) { return modecolor(d.index+1) || modecolor(d.data.index+1);})
  .labelThreshold(.1)
  .showLabels(false);

function readcsv(region,income) {
  
  g.selectAll("circle").data([]).exit().remove(); // remove old circles
  data = {};  

  var fname;
  if(region == "newyork") fname = region+"/minibats"+income+".csv";
  else fname = "batsdata/"+region+"/minibats"+income+".csv";
  d3.csv(fname, function(d) {
    return {
      hhid:  +d.HHID,
      perid: +d.PERID,
      mode:  +d.MODE,
      age:   +d.AGE,
      hour:  +d.ARR_HR,
      lon:   +d.XCORD,
      lat:   +d.YCORD,
      plon:  project([+d.XCORD,+d.YCORD])[0]-projbounds[0][0],
      plat:  project([+d.XCORD,+d.YCORD])[1]-projbounds[0][1],
    };
  }, function(error, rows) {

  rows.forEach(function(r) {
    var key = [r.hhid,r.perid];
    if(!(key in data)) {
      r.mode = 6;
      data[key] = {'key': key, 'first': r};
    }
    data[key][r.hour] = r;
  });
  data = Object.keys(data).map(function(key){return data[key];});
  rezoom();
  hour = $("#slider").slider('value');
 
  d3.select("#modechart svg")
    .datum(modecount(hour))
    .transition().duration(2000)
    .call(chart);

  nv.addGraph(function () {return chart;});

  g.selectAll("circle")
    .data(data,keyf)
    .enter()
    .append("circle")
    .attr("r", function(d) { return d['first'].age/15/Math.sqrt(scale); })
    .style("fill", function(d) { return modecolor(mostrecent(d,hour).mode); })
    .attr("cx", function(d) { return mostrecent(d,hour).plon; })
    .attr("cy", function(d) { return mostrecent(d,hour).plat; });
  });
}
readcsv(region,income);

function keyf(d) { return d['key']; }
  
function modecount(hour) {
  var spec = {};
  var b = map.getBounds();
  for(i=0;i<modes.length;i++) spec[i+1] = {"index": i, "label": modes[i], "value": 0};
  spec[6]["value"] += 1;
  data.forEach(function(d) { 
    var d = mostrecent(d,hour);
    if(d.lat<=b._southWest.lat || d.lat>=b._northEast.lat) return;
    if(d.lon<=b._southWest.lng || d.lon>=b._northEast.lng) return;
    spec[d.mode]["value"] += 1; 
  });

  spec = Object.keys(spec).map(function(key){return spec[key];});
  return spec;
}

function rezoom() {
  var topLeft = project(bounds[0]),
      bottomRight = project(bounds[1]);
  var width = bottomRight[0] - topLeft[0],
      height = bottomRight[1] - topLeft[1];
  var point = map.latLngToLayerPoint(new L.LatLng(bounds[0][1], bounds[0][0]));

  scale = Math.pow(2,map.getZoom() - basezoom);
  svg.attr("width", width*scale)
     .attr("height", height*scale)
     .style("margin-left", point.x + "px")
     .style("margin-top", point.y + "px");

  var s = "translate(" + -point.x + "," + -point.y + ")";
  g.attr("transform",s); 
  g.attr("transform", "scale("+scale+")");
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/15/Math.sqrt(scale); });
}

function rechart() {
  hour = $("#slider").slider('value');
  d3.select("#modechart svg")
    .datum(modecount(hour))
    .transition().duration(1000)
    .call(chart);
}
 
function redraw(hour) {
  d3.select("#metainfo").text((hour<10?"0":"")+hour+":00");
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/15/Math.sqrt(scale); })
    .style("fill", function(d) { return modecolor(mostrecent(d,hour).mode); })
    .transition().duration(2000)
    .attr("cx", function(d) { return mostrecent(d,hour).plon; })
    .attr("cy", function(d) { return mostrecent(d,hour).plat; });
  d3.select("#modechart svg")
    .datum(modecount(hour))
    .transition().duration(1000)
    .call(chart);
}
</script>
</body>
</html>
