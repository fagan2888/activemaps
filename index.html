<html>
<head>
<meta charset="utf-8">
<link rel="icon" href="bat.ico" type="image/x-icon">
<title>BATSMAPS</title>
<style>
.legend {
  line-height: 18px;
  color: #555;
}
.legend i {
  width: 15px;
  height: 15px;
  float: left;
  margin-right: 8px;
  opacity: 0.7;
}
.info {
  padding: 6px 8px;
  font: 14px/16px Arial, Helvetica, sans-serif;
  background: white;
  background: rgba(255,255,255,0.8);
  box-shadow: 0 0 15px rgba(0,0,0,0.2);
  border-radius: 5px;
}
.info h4 {
  margin: 0 0 5px;
  color: #777;
}
html { height: 100%; }
body {height: 100%; margin: 0; padding: 0;}
#map{ height: 100% }
</style>
<link rel="stylesheet" href="js/leaflet.css" />
<script src="js/leaflet.js"></script>
<script type="text/javascript" src="js/tile.stamen.js"></script>
<script src="js/d3.v3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<link rel="stylesheet" href="js/jquery-ui.css" />
<script src="js/jquery-1.9.1.js"></script>
<script src="js/jquery-ui.js"></script>
<body>
<div id="map" style="width:100%; height:100%; position:fixed; left:0; top:0; overflow:hidden;"></div>
<div id=metainfo unselectable="on" class="unselectable" style="border-width: thick; border-color: #D9D9D9; border-style: solid; position: absolute; left: 5px; top: 325px; background-color: #D9D9D9; color: white; font-size: 24px; font-family: Arial; text-shadow: 2px 2px #888;">00:00</div>
<div id="slider" style="position: absolute; top: 75px; left: 15px; height:240px;"></div>
<div id="legend" class="info legend" style="position: absolute; bottom: 25px; right: 10px;"></div>
<script type="text/javascript">
  
$(function() {
  var labels = [];
  for (var i = 0; i < modes.length; i++) {
    labels.push('<i style="background:' + modecolor(i+1) + '"></i>' +modes[i]);
  }
  var legend = labels.join('<br>')+"<br>Size=Age";
  $("#legend").html(legend);

  $( "#slider" ).slider({
    orientation: "vertical",
    min: 1,
    max: 24,
    step: 1,
    slide: function( event, ui ) { redraw(ui.value); }
  });
});

var basezoom = 10;
var map = new L.Map("map", {center: [37.7792, -122.4191], zoom: basezoom});
var layer = new L.StamenTileLayer("toner-lite");
map.addLayer(layer);
// legend, incomes, dollar ranges for income


var modecolor = function(d) {
  if (d == 3) return "red";      // walk
  if (d == 2) return "orange";  // bike
  if (d == 1) return "yellow"; // transit
  if (d == 4) return "green"; // other
  if (d == 5) return "blue"; // car
  if (d == 6) return "brown"; // home
} 

var modes = ["Walk","Bike","Transit","Other","Car","Home"];
var modecolor = function(d) {
  if (d == 3) return "red";      // walk
  if (d == 2) return "orange";  // bike
  if (d == 1) return "yellow"; // transit
  if (d == 4) return "green"; // other
  if (d == 5) return "blue"; // car
  if (d == 6) return "brown"; // home
} 

function project(x) {
  var point = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
  return [point.x, point.y];
}

var scale = 1.0;

var svg = d3.select(map.getPanes().overlayPane).append("svg")
;//  .on("mousemove", function() { redraw(d3.mouse(this)); });

var g = svg.append("g").attr("class", "leaflet-zoom-hide");

var data = {};
var bounds;
var income = 7;

d3.csv("minibats"+income+".csv", function(d) {
    return {
      hhid:  +d.SAMPN,
      perno: +d.PERNO,
      inc:   +d.INCOM,
      plano: +d.PLANO,
      purp:  +d.APURP1,
      mode:  +d.MODE,
      age:   +d.AGE,
      hour:  +d.ARR_HR,
      lon:   +d.XCORD,
      lat:   +d.YCORD,
      plon:  project([+d.XCORD,+d.YCORD])[0],
      plat:  project([+d.XCORD,+d.YCORD])[1],
    };
  }, function(error, rows) {

  rows.forEach(function(r) {
    var key = [r.hhid,r.perno];
    if(!(key in data)) data[key] = {'key': key, 'first': r};
    data[key][r.hour] = r;
  });
  data = Object.keys(data).map(function(key){return data[key];});

  var ne = map.getBounds()._northEast;
  var sw = map.getBounds()._southWest;
  bounds = [[sw.lng,sw.lat],[ne.lng,ne.lat]];
  map.on("viewreset", rezoom);
  rezoom();

  g.selectAll("circle")
    .data(data,keyf)
    .enter()
    .append("circle")
    .attr("cx", function(d) { return d['first'].plon; })
    .attr("cy", function(d) { return d['first'].plat; })
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); })
    .style("fill", function(d) { return modecolor(6); })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
  
});

function keyf(d) { return d['key']; }

function rezoom() {
  var bottomLeft = project(bounds[0]),
      topRight = project(bounds[1]);

  svg.attr("width", (topRight[0] - bottomLeft[0]))
     .attr("height", (bottomLeft[1] - topRight[1]))
     .style("margin-left", bottomLeft[0] + "px")
     .style("margin-top", topRight[1] + "px");

  g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");
  scale = Math.pow(2,map.getZoom() - basezoom)
  g.attr("transform", "scale("+scale+")");
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); });
}

function redraw(hour) {
  var bottomLeft = project(bounds[0]),
      topRight = project(bounds[1]);
  d3.select("#metainfo").text((hour<10?"0":"")+hour+":00");
  function mostrecent(d,hour) {
    for(;hour>0;hour--) {
      if(hour in d) return d[hour];
    }
    return d['first'];
  }
  g.selectAll("circle")
    .data(data)
    .attr("r", function(d) { return d['first'].age/20/Math.sqrt(scale); })
    .style("fill", function(d) { return modecolor(mostrecent(d,hour).mode); })
    .transition().duration(2000)
    .attr("cx", function(d) { return mostrecent(d,hour).plon; })
    .attr("cy", function(d) { return mostrecent(d,hour).plat; })
    .attr('opacity', function(d) {if(d['first'].inc==income) return 1.0; else return 0;});
}
</script>
</body>
</html>
